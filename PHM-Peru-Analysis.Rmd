---
title: "Time Series Analysis"
author: "James Clawson, Antonio Bolea, Kevin Truong"
date: 6/54/2025
date-format: long
format:
  html:
    theme: sandstone
    toc: true
    html-math-method: katex
editor: visual
highlight-style: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Environment Setup

```{r}
#| eval: FALSE

renv::init()      # Initialize the project     
renv::restore()   # Download packages and their version saved in the lockfile
```

```{r}
#| message: FALSE
#| warning: FALSE

suppressPackageStartupMessages({
  library("readr")      # For reading in the data
  library("tibble")     # For handling tidyverse tibble data classes
  library("tidyr")      # For tidying data 
  library("dplyr")      # For data manipulation 
  library("stringr")    # For string manipulation
  library("MASS")       # Functions/datasets for statistical analysis
  library("lubridate")  # For date manipulation
  library("ggplot2")    # For creating static visualizations
  library("RColorBrewer")# For colors in graphs.
  library("scales")     # For formatting plots axis
  library("gridExtra")  # Creates multiple grid-based plots
})


# Function to select "Not In"
'%!in%' <- function(x,y)!('%in%'(x,y))
```

## Load the data

NOTE: Location of csv file may be different, adjust accordingly

```{r}
peru <- read.csv('data\\peru.csv')
```

Renaming the columns into English.

```{r}
colnames(peru) <- c('region', 'province', 'district', 'year', 'week', 'department_code', 'geo_code', 'under_5_noncase', 'under_5_case', 'over_60_case', 'under_5_hospitalized', 'over_60_hospitalized', 'under_5_death', 'over_60_death')
glimpse(peru)
```

```{r}
glimpse(peru)
```

```{r}
summary(peru)
```

## Data dictionary

-   **region:** The geographic region in which the data was recorded: refers to Peru's departments (states).

-   **province:** The province in which the data was recorded: refers to Peru's counties.

-   **district:** The district in which the data was recorded: refers to Peru's towns/cities. Data was collected at local government health establishments.

-   **year:** The year in which the data was recorded.

-   **week:** The specific week of the year in which the data was recorded.

-   **department_code:** The code of the health directorate in which the data was recorded.

-   **geo_code:** The geographical identification code of the area in which the data was recorded. Peru uses UBIGEO— "UBlcación GEOgráfica," a code assigned to particular districts in Peru.

-   **under_5_noncase:** A count representing the number of recorded pneumonia non-cases for children under 5-years-old.

-   **under_5_case:** A count representing the number of recorded pneumonia cases for children under 5-years-old.

-   **over_60_case:** A count representing the number of recorded pneumonia cases for adults over 60-years-old.

-   **under_5_hospitalized:** A count representing the number of pneumonia-related hospitalizations for children under 5-years-old.

-   **under_5_death:** A count representing the number of pneumonia-related deaths for children under 5-years-old.

-   **over_60_death:** A count representing the number of pneumonia-related deaths for for adults over 60-years-old.

## Early EDA

Getting estimated dates for vaccine implementation. Set as July 1 of the year it was implemented.

```{r}
# Estimation when PCV7, PCV10 and PCV13 was introduced
pcv7.intro.date <- as.Date('2009-07-01')
pcv10.intro.date <- as.Date('2011-07-01')
pcv13.intro.date <- as.Date('2013-07-01')


```

Aggregate weekly counts as monthly counts, indexed by the start of that month.

```{r}
df <- peru[c("year","week", "under_5_death", "over_60_death")]

#Group by year, week
df <- df %>%
  group_by(year, week) %>%
  summarise(
    total_under_5 = sum(under_5_death, na.rm = TRUE),
    total_over_60 = sum(over_60_death, na.rm = TRUE),
    .groups = "drop"
  )

#Format week in standard format
df <- df %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))

#Aggregate into monthly counts
df <- df %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date) %>%
  summarise(
    under5 = sum(total_under_5,   na.rm = TRUE),
    over60 = sum(total_over_60,   na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
head(df)
```

Simple time series of death counts in \<5 yo and \>60 yo.

```{r}
#| fig.width: 15
#| fig.height: 9

#Legend for vaccine implementation dates
vaccine_dates <- tibble(
  date    = c(pcv7.intro.date, pcv10.intro.date, pcv13.intro.date),
  vaccine = c("PCV7", "PCV10", "PCV13"),
  levels = c("PCV7", "PCV10", "PCV13"))


p1 <- 
  ggplot(df, aes(x = date, y = under5)) +
    geom_line() +
    geom_vline( data = vaccine_dates, aes(xintercept = date, colour = vaccine, linetype = vaccine), size = 0.8) +
    scale_colour_brewer( name = "Vaccine introduction", palette = "Dark2") +
    scale_linetype_discrete(name = "Vaccine introduction") +
    labs(title = "Monthly <5 Deaths Over Time", x = "Month (first day)", y = "Total <5 Deaths") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "bottom", legend.direction = "horizontal")
    

p2 <- 
  ggplot(df, aes(x = date, y = over60)) +
    geom_line() +
    geom_vline( data = vaccine_dates, aes(xintercept = date, colour = vaccine, linetype = vaccine), size = 0.8) +
    scale_colour_brewer( name = "Vaccine introduction", palette = "Dark2") +
    scale_linetype_discrete(name = "Vaccine introduction") +
    labs(title = "Monthly >60 Deaths Over Time", x = "Month (first day)", y = "Total >60 Deaths") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "bottom", legend.direction = "horizontal")
   
# Display the plots side-by-side.
grid.arrange(p1, p2, nrow = 2)
```

It seems like there's a lot more going on with \<5 yo cases, so we will focus on that.

Scatter plot of death count for \<5 yo.

```{r}
#| fig.width: 6
#| fig.height: 4

p1 <- 
  ggplot(df, aes(x = date, y = under5)) +
      geom_point() +
      labs(title = "<5 yo Deaths Scatter Plot",
         x = "Date", y = "Counts") +
      # Have y-axis for the two plots be the same.
      ylim(0, NA) +
      theme_linedraw() +
      # Specify aspects of the theme plot formatting settings.
      theme(panel.spacing = unit(2, 'lines'), 
            axis.text.x = element_text(angle = 90))

p1
```

Histogram for distribution of deaths

```{r}
deaths_by_region <- peru %>%
  group_by(region) %>%
  summarise(total_deaths = sum(under_5_death), .groups = "drop")

Total_Deaths <- deaths_by_region$total_deaths
deaths_hist <- hist(Total_Deaths, breaks=8,
                    main="Overall distribution of death counts across regions",
                    xlab="Total Death Counts",
                    col="darkmagenta")

```

Visualizing the number of deaths by region

```{r}


p3 <- ggplot(deaths_by_region, 
             aes(x = reorder(region, total_deaths), y = total_deaths)) +
  geom_col(fill = "skyblue") +
  labs(
    title = "Total <5 Deaths by Region",
    x = "Region",
    y = "Total <5 Deaths"
  ) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

p3
```

Aggregate weekly counts as monthly counts, indexed by the start of that month. (copied from above, can delete)

```{r}
df <- peru[c("year","week", "region", "under_5_death")]

#Group by year, week
df <- df %>%
  group_by(year, week, region) %>%
  summarise(
    total_under_5 = sum(under_5_death, na.rm = TRUE),
    .groups = "drop"
  )

#Format week in standard format
df <- df %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))

#Aggregate into monthly counts
df <- df %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date, region) %>%
  summarise(
    under5 = sum(total_under_5,   na.rm = TRUE),
    .groups = "drop"
  )
```

making a line plot of deaths by month and region

```{r}

#creating a function to map deaths by region

region_to_point <- function(data, region_name) {
  
  data <- data %>% filter(region == region_name)
  
  p <- ggplot(data, aes(x = date, y = under5)) +
    geom_line() + 
    geom_vline(data = vaccine_dates, aes(xintercept = date, colour = vaccine, linetype = vaccine), size = 0.8) +
    scale_colour_brewer(name = "Vaccine Introduction", palette = "Dark2") +
    scale_linetype_discrete(name = "Vaccine Introduction") +
    labs(title = paste("Monthly <5 Deaths in", region_name), x = "Date", y = "Deaths") +
    theme_minimal()
  
  p
}

```

Example to visualize the function

```{r}
p4a <- region_to_point(df, "SAN MARTIN")
p4b <- region_to_point(df, "PUNO")

grid.arrange(p4a, p4b, nrow = 2)

```
