---
title: "Time Series Analysis"
author: "James Clawson, Antonio Bolea, Kevin Truong"
date: 6/54/2025
date-format: long
format:
  html:
    theme: sandstone
    toc: true
    html-math-method: katex
editor: visual
highlight-style: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Environment Setup

```{r}
#| eval: FALSE

renv::init()      # Initialize the project     
renv::restore()   # Download packages and their version saved in the lockfile
```

```{r}
#| message: FALSE
#| warning: FALSE

suppressPackageStartupMessages({
  library("readr")      # For reading in the data
  library("tibble")     # For handling tidyverse tibble data classes
  library("tidyr")      # For tidying data 
  library("dplyr")      # For data manipulation 
  library("stringr")    # For string manipulation
  library("MASS")       # Functions/datasets for statistical analysis
  library("lubridate")  # For date manipulation
  library("ggplot2")    # For creating static visualizations
  library("scales")     # For formatting plots axis
  library("gridExtra")  # Creates multiple grid-based plots
})


# Function to select "Not In"
'%!in%' <- function(x,y)!('%in%'(x,y))
```

## Load the data

NOTE: Location of csv file may be different, adjust accordingly

```{r}
df_cases <- read.csv('data\\peru\\peru.csv')
df_gps <- read.csv('data\\peru\\peru_gps.csv')
```

```{r}
colnames(df_cases) <- c('region', 'province', 'district', 'year', 'week', 'department_code', 'geo_code', 'under_5_noncase', 'under_5_case', 'over_60_case', 'under_5_hospitalized', 'over_60_hospitalized', 'under_5_death', 'over_60_death')
glimpse(df_cases)
```

```{r}
glimpse(df_gps)
```

```{r}
summary(df_cases)
```

## Data dictionary

-   **region:** The geographic region in which the data was recorded: refers to Peru's departments (states).

-   **province:** The province in which the data was recorded: refers to Peru's counties.

-   **district:** The district in which the data was recorded: refers to Peru's towns/cities. Data was collected at local government health establishments.

-   **year:** .

-   **week:** .

-   **department_code:** .

-   **geo_code:** .

-   **under_5_noncase:** .

-   **under_5_case:** .

-   **over_60_case:** .

-   **under_5_hospitalized:** .

-   **over_60_hospitalized:** .

-   **under_5_death:** .

-   **over_60_death:** .

```{r}
# Estimation when PCV10 and PCV13 was introduced (year)
pcv10.intro.date <- 2011
pcv13.intro.date <- 2013

# Estimation when vaccine efficacy evaluations started as a tuple (year, week)
vax.eval.date <- list()

```

```{r}
total_deaths_df <- df_cases[c("year","week", "under_5_death", "over_60_death")]
total_deaths_by_year <- total_deaths_df %>%
  group_by(year) %>%
  summarise(
    total_under_5   = sum(under_5_death, na.rm = TRUE),
    total_over_60   = sum(over_60_death, na.rm = TRUE)
  )
total_deaths_by_year_week <- total_deaths_df %>%
  group_by(year, week) %>%
  summarise(
    total_under_5 = sum(under_5_death, na.rm = TRUE),
    total_over_60 = sum(over_60_death, na.rm = TRUE),
    .groups = "drop"
  )

total_deaths_by_year_week <- total_deaths_by_year_week %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))
```

```{r}
head(total_deaths_by_year_week)
```

```{r}
#| fig.width: 15
#| fig.height: 6



p1 <- 
  ggplot(total_deaths_by_year_week, aes(x = date, y = total_under_5)) +
      geom_point() +
      labs(title = "Total deaths for <5 yo in Peru",
         x = "Year", y = "Count") +
      # Reference line.
      geom_vline(xintercept = pcv10.intro.date, col = 'red', lty = 2) +
      geom_vline(xintercept = pcv13.intro.date, col = 'green', lty = 2) +
      theme_linedraw()

p2 <- 
  ggplot(total_deaths_by_year_week, aes(x = date, y = total_over_60)) +
      geom_point() +
      labs(title = "Total deaths for >60 yo in Peru",
         x = "Year", y = "Count") +
      # Reference line.
      geom_vline(xintercept = pcv10.intro.date, col = 'red', lty = 2) +
      geom_vline(xintercept = pcv13.intro.date, col = 'green', lty = 2) +
      theme_linedraw()
   
# Display the plots side-by-side.
grid.arrange(p1, p2, nrow = 1)
```
