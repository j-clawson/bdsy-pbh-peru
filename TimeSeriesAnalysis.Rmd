---
title: "Time Series Analysis of Peru and its Region's Pneumonia Death Counts"
author: "James Clawson, Antonio Bolea, Kevin Truong"
date: 8/`2/2025
date-format: long
format:
  html:
    theme: sandstone
    toc: true
    html-math-method: katex
editor: visual
highlight-style: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Environment Setup

```{r}
#| eval: FALSE

renv::init()      # Initialize the project     
renv::restore()   # Download packages and their version saved in the lockfile
```

```{r}
#| message: FALSE
#| warning: FALSE

suppressPackageStartupMessages({
  library("readr")      # For reading in the data
  library("tibble")     # For handling tidyverse tibble data classes
  library("tidyr")      # For tidying data 
  library("dplyr")      # For data manipulation 
  library("stringr")    # For string manipulation
  library("MASS")       # Functions/datasets for statistical analysis
  library("lubridate")  # For date manipulation
  library("ggplot2")    # For creating static visualizations
  library("patchwork")  # For plot stacking
  library("RColorBrewer")# For colors in graphs.
  library("scales")     # For formatting plots axis
  library("gridExtra")  # Creates multiple grid-based plots
})


# Function to select "Not In"
'%!in%' <- function(x,y)!('%in%'(x,y))
```

## Load the data

NOTE: Location of csv file may be different, adjust accordingly

```{r}
peru <- read.csv('data\\peru.csv')
```

Renaming the columns into English.

```{r}
colnames(peru) <- c('region', 'province', 'district', 'year', 'week', 'department_code', 'geo_code', 'under_5_noncase', 'under_5_case', 'over_60_case', 'under_5_hospitalized', 'over_60_hospitalized', 'under_5_death', 'over_60_death')
```

```{r}
glimpse(peru)
```

Getting estimated dates for vaccine implementation. Set as July 1 of the year it was implemented.

```{r}
# Estimation when PCV7, PCV10 and PCV13 was introduced
pcv7_intro_date <- as.Date('2009-07-01')
pcv10_intro_date <- as.Date('2011-07-01')
pcv13_intro_date <- as.Date('2015-07-01')

```

```{r}
df_nation <- peru[c("year","week", "under_5_death", "under_5_case")]

#Group by year, week
df_nation <- df_nation %>%
  group_by(year, week) %>%
  summarise(
    total_under_5 = sum(under_5_death, na.rm = TRUE),
    total_under_5_cases = sum(under_5_case, na.rm = TRUE),
    .groups = "drop"
  )

#Format week in standard format
df_nation <- df_nation %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))

#Aggregate into monthly counts
df_nation <- df_nation %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date) %>%
  summarise(
    under5_deaths = sum(total_under_5,   na.rm = TRUE),
    under5_cases = sum(total_under_5_cases, na.rm= TRUE),
    .groups = "drop"
  )
```

```{r}
df_region <- peru[c("year","week", "region", "under_5_death", "under_5_case")]

#Group by year, week
df_region <- df_region %>%
  group_by(year, week, region) %>%
  summarise(
    under_5_deaths = sum(under_5_death, na.rm = TRUE),
    under_5_cases = sum(under_5_case, na.rm = TRUE),
    .groups = "drop"
  )

#Format week in standard format
df_region <- df_region %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))

#Aggregate into monthly counts
df_region <- df_region %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date, region) %>%
  summarise(
    under5_deaths = sum(under_5_deaths,   na.rm = TRUE),
    under5_cases = sum(under_5_cases, na.rm = TRUE),
    .groups = "drop"
  )
```

Adding ordered & discrete variable for modeling

```{r}
df_nation <- tibble::rownames_to_column(df_nation, var = "index") %>%
  mutate(index = as.numeric(index))

```

```{r}
#| fig.width: 6
#| fig.height: 4

p1 <- 
  ggplot(df_nation, aes(x = date, y = under5_deaths)) +
      geom_point() +
      labs(title = "<5 yo Deaths Scatter Plot",
         x = "Date", y = "Counts") +
      # Have y-axis for the two plots be the same.
      ylim(0, NA) +
      theme_linedraw() +
      # Specify aspects of the theme plot formatting settings.
      theme(panel.spacing = unit(2, 'lines'), 
            axis.text.x = element_text(angle = 90))

p1
```

Plotting the model:

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred <- predict(mod1, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df_pred <- df_nation %>%
  mutate(se.fit = pred$se.fit, pred = pred$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1a <- p1 +
  # Add the fitting line.
  geom_line(data = df_pred, aes(x = date, y = pred),
            color = "#e41a1c") +
  # Add the confidence interval.
  geom_ribbon(data = df_pred, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit")

p1a
```

Now adding seasonality:

```{r}
df_nation$month <- as.factor(month(df_nation$date))

# Inspect the first 36 entries.
df_nation$month[1:36]

# Update the model.
mod1a <- glm.nb(under5_deaths ~ date + month, data = df_nation)
summary(mod1a)
```

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred2 <- predict(mod1a, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df_pred2 <- df_nation %>%
  mutate(se.fit = pred2$se.fit, pred = pred2$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1b <- p1 +
  # Add the fitting line.
  geom_line(data = df_pred2, aes(x = date, y = pred),
            color = "#377eb8") +
  # Add the confidence interval.
  geom_ribbon(data = df_pred2, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit\nSeasonality Term Included")

p1b
```

Adding a offset variable. All pneumonia cases for \<5 yo is used as the offset variable.

```{r}
# Create the offset using all pneumonia cases
df_nation$log_offset <- log(df_nation$under5_cases)

# Refit the model.
model1b <- glm.nb(under5_deaths ~ index + month + offset(log_offset), data = df_nation)

summary(model1b)
```

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred3 <- predict(model1b, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df.pred3 <- df_nation %>%
  mutate(se.fit = pred3$se.fit, pred = pred3$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1c <- p1 +
  # Add the fitting line.
  geom_line(data = df.pred3, aes(x = date, y = pred),
            color = "#4daf4a") +
  # Add the confidence interval.
  geom_ribbon(data = df.pred3, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit\nSeasonality Term and Offset")

p1c
```

To check for changes in disease levels, implement use a spline model, then implement a counter factual (extrapolation based on pre-PCV13 dates).

# Time Series for National Death Counts

First, we will implement two models to see whether the trend or level of the disease changes. We will work on the total national death counts, then make two graphs for each regions later.

## ITS Spline Model

Interrupted Time Series with Connected Segments

```{r}
intro_index <- which(df_nation$date == pcv13_intro_date)
df_nation <- df_nation %>%
  mutate(
    spl1 = ifelse(index - intro_index + 1 < 0, 0, index - intro_index + 1)
  )

# Inspect the changes.
df_nation[65:80, c("date", "index", "spl1", "log_offset")]

```

Fit the spline model.

```{r}
spline_model <- glm.nb(under5_deaths ~ index + month + offset(log_offset) +
                 # Post-vaccine changes.
                 spl1, data = df_nation)

summary(spline_model)
```

```{r}
# Add the prediction using the smoothed model.
df_pred_spl <- df_nation %>%
  mutate(pred.spl = predict(spline_model, type = "response"))

```

Plot the spline model.

```{r}
# Make predictions with confidence intervals.
pred7 <- predict(spline_model, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df_pred_spl <- df_pred_spl %>%
  mutate(se.fit = pred7$se.fit, pred = pred7$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

```

```{r}
# Getting max value to have y-axis the same
ymax_spline <- max(
  df_pred_spl$under5_deaths,
  df_pred_spl$pred.spl,
  df_pred_spl$conf.high,
  na.rm = TRUE
)
```

Plot the model.

```{r}
p7 <- 
  ggplot(df_pred_spl, aes(x = date)) +
    # Observed points
    geom_point(aes(y = under5_deaths, shape = "Observed"), colour = "black", size   = 1,  alpha  = 0.6) +
    # Fitted spline line
    geom_line( aes(y = pred.spl,         color = "Fitted model"), size = 0.6) +
    # Confidence ribbon
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = "95% CI"), 
                alpha = 0.3) +
    # Vaccine introduction marker
    geom_vline(aes(xintercept = pcv13_intro_date, color = "PCV13 implementation"),
               linetype = "dashed", size = 1) +
    # Scales and legend
    scale_color_manual(
      name   = "",
      values = c(
        "Observed"        = "black",
        "Fitted model"    = "#1f77b4",
        "PCV13 implementation"   = "#fb8500"
      )
    ) +
    scale_fill_manual(
      name   = "",
      values = c("95% CI" = "#8ecae6")
    ) +
    scale_shape_manual(
      name   = "",
      values = c("Observed" = 16)
    ) +
    coord_cartesian(ylim = c(0, ymax_spline)) +
    labs(
      title = "Peru - ITS Spline Fit",
      x     = "Date",
      y     = "<5 yo Deaths"
    ) +
    theme_linedraw() +
    theme(
      axis.text.x     = element_text(size = 10, angle = 90, hjust = 1),
      axis.text.y     = element_text(size = 10),
      legend.position = "top",
      legend.text     = element_text(size = 10),
      plot.title      = element_text(face = "bold", size = 12)
    )


p7
```

## Counter factual (Extrapolation Based on the Pre-Vaccine Period)

```{r}
df_pre13 <- df_nation

#Set the pneumonia variable to NA during the post-vaccine period
df_pre13$under5_deaths_pre <- df_pre13$under5_deaths

df_pre13$under5_deaths_pre[which(df_pre13$date >= pcv13_intro_date)] <- NA


```

```{r}
cf_model<- glm.nb(under5_deaths_pre ~ index # Time trend
              + month # Seasonality
              + offset(log_offset), data = df_pre13)

# Add the prediction using the smoothed model.
ds.pred.cf_model <- df_pre13 %>%
  mutate(pred.cf_model = predict(cf_model, type = "response", newdata = df_pre13))
```

Plot the model

```{r}

p9 <- ggplot(ds.pred.cf_model, aes(x = date)) +
  # observed points
  geom_point(aes(y = under5_deaths_pre, color = "Observed", shape = "Observed"), size = 1, alpha = 0.6) +
  # fitted (counterfactual) line
  geom_line( aes(y = pred.cf_model,    color = "Fitted model"),  size = 0.6) +
  # vaccine rollout
  geom_vline(aes(xintercept = pcv13_intro_date, color = "PCV13 implementation"),
             linetype = "dashed", size = 1) +
  
  # now define the legend entries and their colours
  scale_color_manual(
    name = "",    # no legend title
    values = c(
      "Observed"      = "black",
      "Fitted model"  = "#1f77b4",
      "PCV13 implementation" = "#fb8500"
    )
  ) +
  # if you want shapes in the legend for points:
  scale_shape_manual(
    name   = "",
    values = c("Observed" = 16)
  ) +
  coord_cartesian(ylim = c(0, ymax_spline)) +
  labs(
    title = "Peru - Pre-Vaccine Extrapolation",
    x     = "Date",
    y     = "<5 yo Deaths"
  ) +
  theme_linedraw() +
  theme(
    axis.text.x     = element_text(size = 10, angle = 90, hjust = 1),
    axis.text.y     = element_text(size = 10),
    legend.position = "top",
    legend.text     = element_text(size = 10),
    plot.title      = element_text(face = "bold", size = 12)
  )
p9
```

```{r}
combined <- p7 | p9

ggsave(
  filename = "PERU_two_panel.png",
  plot     = combined,
  width    = 11, #7
  height   = 5, #9
  units    = "in",
  dpi      = 300
)
```

# Regional Time Series Analysis

Now we will implement these models for the bottom Five Poorest countries, then for each region.

```{r}
regions_bottom5 <- c("PUNO", "HUANCAVELICA", "SAN MARTIN", "APURIMAC", "HUANUCO")

df_bottom5_sum <- df_region %>%
  filter(region %in% regions_bottom5) %>%      # keep only the five regions
  group_by(date) %>%                        # aggregate by date
  summarise(
    under5_deaths = sum(under5_deaths, na.rm = TRUE),
    under5_cases  = sum(under5_cases,  na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(region = "Five Poorest (sum)")    # optional label

df_bottom5_sum
```

## Functions

Function for a regional spline ITS plot.

```{r}

plot_region_spline <- function(region_name,
                               df_region,
                               intro_date,
                               filter_region = TRUE,
                               y_max = NULL,
                               title_suffix = "- ITS Spline Fit") {
  # Prepare data frame (either filter or treat as already aggregated)
  if (filter_region) {
    df_reg <- df_region %>%
      filter(tolower(region) == tolower(region_name)) %>%
      arrange(date)
    if (nrow(df_reg) == 0)
      stop("Region '", region_name, "' not found in df_region.")
  } else {
    df_reg <- df_region %>%
      arrange(date)
  }

  # Index of intro date (ensure intro_date exists)
  if (!intro_date %in% df_reg$date) {
    warning("intro_date not found in the series; spline change term may be misaligned.")
  }

  intro_idx <- which(df_reg$date == intro_date)[1]

  df_plot <- df_reg %>%
    mutate(
      index      = row_number(),
      month      = factor(month(date), levels = 1:12),
      log_offset = log(under5_cases + 1),
      # Simple post‑intro slope change term (0 pre, increasing after)
      spl1       = ifelse(is.na(intro_idx), 0, pmax(index - intro_idx + 1, 0))
    )

  mod  <- glm.nb(under5_deaths ~ index + month + offset(log_offset) + spl1, data = df_plot)
  pred <- predict(mod, type = "response", se.fit = TRUE)

  df_plot <- df_plot %>%
    mutate(
      fit     = pred$fit,
      se      = pred$se.fit,
      conf.lo = pmax(fit - 1.96 * se, 0),
      conf.hi = fit + 1.96 * se
    )
  if (is.null(y_max)) {
    y_max <- max(df_plot$under5_deaths, df_plot$conf.hi, na.rm = TRUE)
    y_max <- ceiling(y_max * 1.05)
  }



  ggplot(df_plot) +
    geom_point(aes(x = date, y = under5_deaths, shape = "Observed"),
               color = "black", size = 1, alpha = 0.6) +
    geom_ribbon(aes(x = date, ymin = conf.lo, ymax = conf.hi, fill = "95% CI"),
                alpha = 0.25) +
    geom_line(aes(x = date, y = fit, color = "Fitted model"), size = 0.6) +
    geom_vline(aes(xintercept = intro_date, color = "PCV13 introduction"),
               linetype = "dashed", size = 1) +
    scale_color_manual(values = c("Fitted model" = "#1f77b4",
                                  "PCV13 introduction" = "#fb8500"),
                       name = "") +
    scale_fill_manual(values = c("95% CI" = "#219ebc"), name = "") +
    scale_shape_manual(values = c("Observed" = 16), name = "") +
    coord_cartesian(ylim = c(0, y_max)) +
    labs(
      title = paste(region_name, title_suffix),
      x = "Date", y = "<5 yo Deaths"
    ) +
    theme_linedraw() +
    theme(
      axis.text.x     = element_text(size = 9, angle = 90, hjust = 1),
      axis.text.y     = element_text(size = 10),
      legend.position = "top",
      legend.text     = element_text(size = 10),
      plot.title      = element_text(face = "bold", size = 12)
    )
}

```

Function for the region's counter factual.

```{r}
plot_region_extrapolation <- function(region_name,
                                      df_region,
                                      intro_date,
                                      filter_region = TRUE,
                                      y_max = NULL,
                                      title_suffix = "- Pre-Vaccine Extrapolation") {

  if (filter_region) {
    df_reg <- df_region %>%
      filter(tolower(region) == tolower(region_name)) %>%
      arrange(date)
    if (nrow(df_reg) == 0)
      stop("Region '", region_name, "' not found in df_region.")
  } else {
    df_reg <- df_region %>% arrange(date)
  }

  df_reg <- df_reg %>%
    mutate(
      index      = row_number(),
      month      = factor(month(date), levels = 1:12),
      log_offset = log(under5_cases + 1),
      deaths_pre = if_else(date < intro_date, under5_deaths, NA_real_)
    )

  df_fit <- df_reg %>% filter(!is.na(deaths_pre))
  if (nrow(df_fit) == 0)
    stop("No pre-vaccine data available before intro_date for region ", region_name)

  cf_mod <- glm.nb(deaths_pre ~ index + month + offset(log_offset), data = df_fit)

  df_plot <- df_reg %>%
    mutate(fit_cf = predict(cf_mod, newdata = df_reg, type = "response"))

  if (is.null(y_max)) {
    y_max <- max(df_plot$under5_deaths, df_plot$fit_cf, na.rm = TRUE)
    y_max <- ceiling(y_max * 1.05)
  }


  ggplot() +
    geom_point(
      data = df_plot %>% filter(!is.na(deaths_pre)),
      aes(x = date, y = deaths_pre, shape = "Observed"),
      color = "black", size = 1, alpha = 0.6
    ) +
    geom_line(
      data = df_plot,
      aes(x = date, y = fit_cf, color = "Counterfactual"),
      size = 0.6
    ) +
    geom_vline(
      aes(xintercept = intro_date, color = "PCV13 introduction"),
      linetype = "dashed", size = 1
    ) +
    scale_color_manual(
      name = "",
      values = c("Counterfactual" = "red",
                 "PCV13 introduction" = "#fb8500")
    ) +
    scale_shape_manual(name = "", values = c("Observed" = 16)) +
    coord_cartesian(ylim = c(0, y_max)) +
    labs(
      title = paste(region_name, title_suffix),
      x = "Date", y = "<5 yo Deaths"
    ) +
    theme_linedraw() +
    theme(
      axis.text.x     = element_text(size = 9, angle = 90, hjust = 1),
      axis.text.y     = element_text(size = 10),
      legend.position = "top",
      legend.text     = element_text(size = 10),
      plot.title      = element_text(face = "bold", size = 12)
    )
}
```

```{r}
plot_both_with_shared_scale <- function(region_name, df_region, intro_date, filter_region = TRUE) {

  # Build a unified modeling frame
  if (filter_region) {
    base_df <- df_region %>%
      filter(tolower(region) == tolower(region_name)) %>%
      arrange(date)
  } else {
    base_df <- df_region %>% arrange(date)
  }

  df_base <- base_df %>%
    mutate(index = row_number(),
           month = factor(lubridate::month(date), levels = 1:12),
           log_offset = log(under5_cases + 1),
           deaths_pre = if_else(date < intro_date, under5_deaths, NA_real_))

  # Counterfactual
  cf_mod <- glm.nb(deaths_pre ~ index + month + offset(log_offset),
                   data = df_base %>% filter(!is.na(deaths_pre)))
  df_cf  <- df_base %>% mutate(fit_cf = predict(cf_mod, newdata = ., type = "response"))

  # Spline
  intro_idx <- which(df_base$date == intro_date)[1]
  df_spl <- df_base %>%
    mutate(spl1 = ifelse(length(intro_idx)==0, 0, pmax(index - intro_idx + 1, 0)))
  spl_mod <- glm.nb(under5_deaths ~ index + month + offset(log_offset) + spl1, data = df_spl)
  pred_spl <- predict(spl_mod, type = "response", se.fit = TRUE)
  df_spl <- df_spl %>%
    mutate(fit = pred_spl$fit,
           se = pred_spl$se.fit,
           conf.hi = fit + 1.96 * se)

  shared_y_max <- max(df_cf$under5_deaths, df_cf$fit_cf,
                      df_spl$under5_deaths, df_spl$conf.hi, na.rm = TRUE)
  shared_y_max <- ceiling(shared_y_max * 1.05)

  # Reuse the existing plotting functions
  p_cf <- plot_region_extrapolation(region_name, df_region, intro_date,
                                    filter_region = filter_region,
                                    y_max = shared_y_max)

  p_spl <- plot_region_spline(region_name, df_region, intro_date,
                              filter_region = filter_region,
                              y_max = shared_y_max)

  list(
  spline_plot        = p_spl,  
  counterfactual_plot = p_cf        
  )
}


```

```{r}
plots <- plot_both_with_shared_scale("Five Poorest (sum)", df_bottom5_sum, pcv13_intro_date, FALSE)

p_spline <- plots$spline_plot
p_cf     <- plots$counterfactual_plot

# display
print(p_spline)
print(p_cf)
```

```{r}
combined <- p_spline | p_cf

ggsave(
  filename = "FIVE_POOREST_two_panel.png",
  plot     = combined,
  width    =11, #7
  height   = 5, #9
  units    = "in",
  dpi      = 300
)
```

# Overlaying Plots

Now we will overlay the spline model and counter factual.

## Regional Overlay

```{r}
library(dplyr)

plot_region_overlay <- function(region_name, df_region, intro_date, filter_region = TRUE) {

  ## 1) Prep 
  df_base <- if (filter_region) {
    df_region %>% filter(tolower(region) == tolower(region_name)) %>% arrange(date)
  } else {
    df_region %>% arrange(date)
  }

  df_base <- df_base %>%
    mutate(index = row_number(),
           month = factor(lubridate::month(date), levels = 1:12),
           log_offset = log(under5_cases + 1),
           deaths_pre = if_else(date < intro_date, under5_deaths, NA_real_))

  ## 2) Counterfactual model (PRE ONLY)
  cf_fit  <- df_base %>% filter(!is.na(deaths_pre))
  cf_mod  <- MASS::glm.nb(deaths_pre ~ index + month + offset(log_offset), data = cf_fit)
  cf_df   <- df_base %>% mutate(fit_cf = predict(cf_mod, newdata = df_base, type = "response"))

  ## 3) Spline ITS model (FULL SPAN)
  intro_idx <- which(df_base$date == intro_date)[1]
  df_spl_in <- df_base %>%
    mutate(spl1 = if (length(intro_idx) == 0) 0 else pmax(index - intro_idx + 1, 0))

  spl_mod <- MASS::glm.nb(under5_deaths ~ index + month + offset(log_offset) + spl1,
                          data = df_spl_in)
  ps      <- predict(spl_mod, type = "response", se.fit = TRUE)

  spl_df  <- df_spl_in %>%
    mutate(fit = ps$fit,
           se  = ps$se.fit,
           conf.lo = pmax(fit - 1.96 * se, 0),
           conf.hi = fit + 1.96 * se)

  ## 4) Merge 
  df_plot <- dplyr::left_join(
    cf_df %>% dplyr::select(date, deaths_pre, under5_deaths, fit_cf),
    spl_df %>% dplyr::select(date, fit, conf.lo, conf.hi),
    by = "date"
  )

  ## 4b) Bootstrap RR (Observed / Counterfactual post-PCV) 
  set.seed(123)
  n_sim   <- 5000
  post_ix <- df_plot$date >= intro_date
  theta   <- cf_mod$theta

  mu_obs <- df_plot$under5_deaths[post_ix]
  mu_cf  <- df_plot$fit_cf[post_ix]

  rr_sims <- replicate(n_sim, {
    sim_obs <- rnbinom(length(mu_obs), mu = mu_obs, size = theta)
    sim_cf  <- rnbinom(length(mu_cf),  mu = mu_cf,  size = theta)
    sum(sim_obs) / sum(sim_cf)
  })

  RR_post <- mean(rr_sims)
  ci_post <- quantile(rr_sims, c(.025, .975))

  rr_summary <- data.frame(RR_post = RR_post,
                           CI_low  = ci_post[1],
                           CI_high = ci_post[2])

  ## 5) Y-limit 
  y_max <- max(df_plot$under5_deaths, df_plot$fit_cf, df_plot$conf.hi, na.rm = TRUE)
  y_max <- ceiling(y_max * 1.05)

  ## 6) Plot
  p <- ggplot(df_plot, aes(x = date)) +
    geom_point(aes(y = under5_deaths, shape = "Observed"),
               color = "black", size = 1, alpha = 0.6) +
    geom_ribbon(aes(ymin = conf.lo, ymax = conf.hi, fill = "95% CI"), alpha = 0.25) +
    geom_line(aes(y = fit,    color = "Spline ITS"),       size = 0.7) +
    geom_line(aes(y = fit_cf, color = "Counterfactual"),   size = 0.7, linetype = "dashed") +
    geom_vline(data = data.frame(x = intro_date),
               inherit.aes = FALSE,
               aes(xintercept = x, color = "PCV13 introduction"),
               linetype = "dotdash", size = 1) +
    scale_color_manual(name = "", values = c(
      "Spline ITS" = "#1f77b4",
      "Counterfactual" = "#fb8500",
      "PCV13 introduction" = "gray30"
    )) +
    scale_fill_manual(name = "", values = c("95% CI" = "#219ebc")) +
    scale_shape_manual(name = "", values = c("Observed" = 16)) +
    coord_cartesian(ylim = c(0, y_max)) +
    labs(title = paste(region_name, "— Spline ITS & Counterfactual"),
         x = "Date", y = "<5 yo Deaths") +
    theme_linedraw() +
    theme(
      axis.text.x  = element_text(size = 14, angle = 90, hjust = 1),
      axis.title.x = element_text(size = 15),
      axis.text.y  = element_text(size = 14),
      axis.title.y = element_text(size = 15),
      legend.position = "top",
      legend.text  = element_text(size = 11),
      plot.title   = element_text(face = "bold", size = 15)
    )

  ## 7) Return 
  list(plot = p,
       rr_summary = rr_summary,
       rr_sims = rr_sims,
       data = df_plot)
}

```

```{r}
p_overlay <- plot_region_overlay("Five Poorest (sum)", df_bottom5_sum, pcv13_intro_date, FALSE)
p_overlay$rr_summary
p_overlay$plot
```

```{r}
ggsave(
  filename = "FIVE_POOREST_overlay.png",
  plot     = p_overlay,
  width    =9, #9, 11
  height   = 7, #7, 5
  units    = "in",
  dpi      = 300
)
```

## National Plot Overlay

```{r}
p_peru_overlay <- plot_region_overlay("National", df_nation, pcv13_intro_date, FALSE)
p_peru_overlay$rr_summary
p_overlay$plot
```

```{r}
ggsave(
  filename = "PERU_overlay.png",
  plot     = p_peru_overlay,
  width    =9, #9
  height   = 7, #7
  units    = "in",
  dpi      = 300
)
```
