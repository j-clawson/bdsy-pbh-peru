---
title: "EDA of Peru Pneumonia Death Counts"
author: "James Clawson, Antonio Bolea, Kevin Truong"
date: 6/54/2025
date-format: long
format:
  html:
    theme: sandstone
    toc: true
    html-math-method: katex
editor: visual
highlight-style: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Environment Setup

```{r}
#| eval: FALSE

renv::init()      # Initialize the project     
renv::restore()   # Download packages and their version saved in the lockfile
```

```{r}
#| message: FALSE
#| warning: FALSE

suppressPackageStartupMessages({
  library("readr")      # For reading in the data
  library("tibble")     # For handling tidyverse tibble data classes
  library("tidyr")      # For tidying data 
  library("dplyr")      # For data manipulation 
  library("stringr")    # For string manipulation
  library("MASS")       # Functions/datasets for statistical analysis
  library("lubridate")  # For date manipulation
  library("ggplot2")    # For creating static visualizations
  library("RColorBrewer")# For colors in graphs.
  library("scales")     # For formatting plots axis
  library("gridExtra")  # Creates multiple grid-based plots
})


# Function to select "Not In"
'%!in%' <- function(x,y)!('%in%'(x,y))
```

## Load the data

NOTE: Location of csv file may be different, adjust accordingly

```{r}
peru <- read.csv('data\\peru.csv')
```

Renaming the columns into English.

```{r}
colnames(peru) <- c('region', 'province', 'district', 'year', 'week', 'department_code', 'geo_code', 'under_5_noncase', 'under_5_case', 'over_60_case', 'under_5_hospitalized', 'over_60_hospitalized', 'under_5_death', 'over_60_death')
glimpse(peru)
```

```{r}
glimpse(peru)
```

Getting estimated dates for vaccine implementation. Set as July 1 of the year it was implemented.

```{r}
# Estimation when PCV7, PCV10 and PCV13 was introduced
pcv7.intro.date <- as.Date('2009-07-01')
pcv10.intro.date <- as.Date('2011-07-01')
pcv13.intro.date <- as.Date('2013-07-01')

```

```{r}
df_nation <- peru[c("year","week", "under_5_death", "under_5_case")]

#Group by year, week
df_nation <- df_nation %>%
  group_by(year, week) %>%
  summarise(
    total_under_5 = sum(under_5_death, na.rm = TRUE),
    total_under_5_cases = sum(under_5_case, na.rm = TRUE),
    .groups = "drop"
  )

#Format week in standard format
df_nation <- df_nation %>%
  mutate(date = as.Date(paste0(year, '-01-01')) + weeks(week-1))

#Aggregate into monthly counts
df_nation <- df_nation %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date) %>%
  summarise(
    under5_deaths = sum(total_under_5,   na.rm = TRUE),
    under5_cases = sum(total_under_5_cases, na.rm= TRUE),
    .groups = "drop"
  )
```

# Time Series

First, fit a simple GLM with a negative binomial fit for the nation's \<5 yo death counts.

```{r}
# For modeling, we need to use an ordered, discrete variable. Simply, we 
# can use the rownames for this purpose.
df_ts <- tibble::rownames_to_column(df_nation, var = "index") %>%
  mutate(index = as.numeric(index))

# Apply the negative binomial regression.
mod1 <- glm.nb(under5_deaths ~ index , data = df_ts)

# Examine the fitting results.
summary(mod1)
```

Plotting the model:

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred <- predict(mod1, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df_pred <- df_ts %>%
  mutate(se.fit = pred$se.fit, pred = pred$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1a <- p1 +
  # Add the fitting line.
  geom_line(data = df_pred, aes(x = date, y = pred),
            color = "#e41a1c") +
  # Add the confidence interval.
  geom_ribbon(data = df_pred, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit")

p1a
```

Now adding seasonality:

```{r}
df_ts$month <- as.factor(month(df_ts$date))

# Inspect the first 36 entries.
df_ts$month[1:36]

# Update the model.
mod1a <- glm.nb(under5_deaths ~ date + month, data = df_ts)
summary(mod1a)
```

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred2 <- predict(mod1a, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df_pred2 <- df_ts %>%
  mutate(se.fit = pred2$se.fit, pred = pred2$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1b <- p1 +
  # Add the fitting line.
  geom_line(data = df_pred2, aes(x = date, y = pred),
            color = "#377eb8") +
  # Add the confidence interval.
  geom_ribbon(data = df_pred2, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit\nSeasonality Term Included")

p1b
```

Adding a offset variable. All pneumonia cases for \<5 yo is used as the offset variable.

```{r}
# Create the offset using all pneumonia cases
df_ts$log_offset <- log(df_ts$under5_cases)

# Refit the model.
model1b <- glm.nb(under5_deaths ~ index + month + offset(log_offset), data = df_ts)

summary(model1b)
```

```{r}
#| fig.width: 6
#| fig.height: 4

# Make predictions with confidence intervals.
pred3 <- predict(model1b, type = "response", se.fit = TRUE)

# Add the model predictions and 95% COI to the dataframe.
df.pred3 <- df_ts %>%
  mutate(se.fit = pred3$se.fit, pred = pred3$fit) %>%
  mutate(
    conf.low = pred - 1.96 * se.fit,
    conf.high = pred + 1.96 * se.fit
  )

# Plot the newly created model fitting.
p1c <- p1 +
  # Add the fitting line.
  geom_line(data = df.pred3, aes(x = date, y = pred),
            color = "#4daf4a") +
  # Add the confidence interval.
  geom_ribbon(data = df.pred3, aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.2, fill = "blue") +
  # Change the title name.
  labs(title = "Deaths with a Negative Binomial Fit\nSeasonality Term and Offset")

p1c
```

To check for changes in disease levels, implement use a spline model, then implement a counter factual (extrapolation based on pre-PCV13 dates).

## Spline Model

## Counter factual

```{r}
df_pre13 <- df_ts

#Set the pneumonia variable to NA during the post-vaccine period
df_pre13$under5_deaths_pre <- df_pre13$under5_deaths

df_pre13$under5_deaths_pre[which(df_pre13$date >= pcv13.intro.date)] <- NA


```

```{r}
mod5<- glm.nb(under5_deaths_pre ~ index # Time trend
              + month # Seasonality
              + offset(log_offset), data = df_pre13)

# Add the prediction using the smoothed model.
ds.pred.mod5 <- df_pre13 %>%
  mutate(pred.mod5 = predict(mod5, type = "response", newdata = df_pre13))
```

Plot the model

```{r}

p9 <- ggplot(ds.pred.mod5, aes(x=date, y=under5_deaths_pre)) +
      geom_point() +
      ylab("Deaths, <5 yo") +
      xlab("Date") +
      theme_linedraw() +
      theme(panel.spacing= unit(2,'lines') , axis.text.x=element_text(angle=90)) +
      geom_hline(yintercept=0, col='gray', lty=2) +
      geom_line(color='#377eb8', data=ds.pred.mod5, aes(x=date, y=pred.mod5))
p9
```
